- name: Deploy WBA of Texas website via Docker
  hosts: web01
  become: true
  tasks:
    - name: Log into DockerHub
      docker_login:
        username: '{{ lookup("env", "DOCKERHUB_USERNAME") }}'
        password: '{{ lookup("env", "DOCKERHUB_PASSWORD") }}'

    - name: Creates directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop:
        - /home/ubuntu/deploy
        - /home/ubuntu/deploy/wbaoftexas
        - /home/ubuntu/deploy/wbaoftexas/data
        - /home/ubuntu/deploy/wbaoftexas/data/mariadb
        - /home/ubuntu/deploy/wbaoftexas/secrets

    - name: Create shared Docker network
      community.docker.docker_network:
        name: shared
        state: present

    - name: copy Docker Compose files
      copy:
        src: "{{ item }}"
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/wbaoftexas/{{ item }}"
      loop:
      - docker-compose.yaml

    - name: copy secrets
      copy:
        src: "../secret/{{ item }}"
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/wbaoftexas/secrets/{{ item }}"
      loop:
      - wbaoftexas_db_pw.txt
      - wbaoftexas_db_root_pw.txt

    - name: Deploy with docker compose
      ansible.builtin.shell:
        cmd: "export WBAOFTEXAS_DB_PASS=$(cat secrets/wbaoftexas_db_pw.txt) && docker compose up -d"
        chdir: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/wbaoftexas/"
      register: compose_up_result

    - name: Restart nginx to pick up wbaoftexas on shared network
      ansible.builtin.shell:
        cmd: "docker compose restart web"
        chdir: /home/ubuntu/deploy/nginx
      register: nginx_restart_result
      failed_when: false
      changed_when: nginx_restart_result.rc == 0
