- name: Deploy ProjectSend
  hosts: web01
  become: yes
  vars:
    project_name: projectsend
    root_dir: /home/ubuntu/deploy/projectsend
  tasks:
    - name: Creates directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop:
        - /home/ubuntu/deploy
        - "{{ root_dir }}"
        - "{{ root_dir }}/secrets"
        - "{{ root_dir }}/data"
        - "{{ root_dir }}/data/mariadb"
        - "{{ root_dir }}/data/web"
        - "{{ root_dir }}/data/config"

    - name: Create shared Docker network
      community.docker.docker_network:
        name: shared
        state: present

    - name: copy secrets
      copy:
        src: "../secret/{{ item }}"
        dest: "{{ root_dir }}/secrets/{{ item }}"
      loop:
        - "{{ project_name }}_db_pw.txt"
        - "{{ project_name }}_db_root_pw.txt"

    - name: copy Docker Compose files
      copy:
        src: "{{ item }}"
        dest: "{{ root_dir }}/{{ item }}"
      loop:
      - docker-compose.yaml

    - name: Deploy with docker compose
      ansible.builtin.shell:
        cmd: "docker compose up -d"
        chdir: "{{ root_dir }}"
      register: compose_up_result

    - name: Restart nginx to pick up projectsend on shared network
      ansible.builtin.shell:
        cmd: "docker compose restart web"
        chdir: /home/ubuntu/deploy/nginx
      register: nginx_restart_result
      failed_when: false
      changed_when: nginx_restart_result.rc == 0

    # - name: copy scripts
    #   copy:
    #     src: "scripts/{{ item }}"
    #     dest: "{{ root_dir }}/{{ item }}"
    #   loop:
    #     - backup.sh

    # - name: Create backup cronjob
    #   ansible.builtin.cron:
    #     name: "check dirs"
    #     minute: "0"
    #     hour: "0"
    #     job: "{{ root_dir }}/backup.sh > /dev/null"
