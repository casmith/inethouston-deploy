- name: Deploy Strapi via Docker
  hosts: web01
  become: true
  tasks:
    - name: Log into DockerHub
      docker_login:
        username: '{{ lookup("env", "DOCKERHUB_USERNAME") }}'
        password: '{{ lookup("env", "DOCKERHUB_PASSWORD") }}'

    - name: Creates directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop:
        - /home/ubuntu/deploy
        - /home/ubuntu/deploy/strapi
        - /home/ubuntu/deploy/strapi/data
        - /home/ubuntu/deploy/strapi/secrets

    - name: Create shared Docker network
      community.docker.docker_network:
        name: shared
        state: present

    - name: copy Docker Compose files
      copy:
        src: "{{ item }}"
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/strapi/{{ item }}"
      loop:
      - docker-compose.yaml

    - name: copy secrets
      copy:
        src: "../secret/{{ item }}"
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/strapi/secrets/{{ item }}"
      loop:
      - strapi_db_pw.txt

    - name: Deploy with docker compose
      ansible.builtin.shell:
        cmd: "docker compose up -d"
        chdir: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/strapi/"
      register: compose_up_result

    - name: Restart nginx to pick up strapi on shared network
      ansible.builtin.shell:
        cmd: "docker compose restart web"
        chdir: /home/ubuntu/deploy/nginx
      register: nginx_restart_result
      failed_when: false
      changed_when: nginx_restart_result.rc == 0
