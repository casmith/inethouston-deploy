name: Nightly Database Backup

on:
  schedule:
    # Run at 5:00 AM UTC (midnight EST / 11 PM CST)
    - cron: '0 5 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

jobs:
  backup:
    name: Backup All Databases
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Set up SSH
        run: |
          echo "${{ secrets.SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Run database backups
        env:
          SSH_USER: ${{ secrets.ANSIBLE_USER }}
          SSH_HOST: 207.244.244.247
          CONTABO_S3_ACCESS_KEY: ${{ secrets.CONTABO_S3_ACCESS_KEY }}
          CONTABO_S3_SECRET_KEY: ${{ secrets.CONTABO_S3_SECRET_KEY }}
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${SSH_USER}@${SSH_HOST} \
            "export AWS_ACCESS_KEY_ID='${CONTABO_S3_ACCESS_KEY}' && \
             export AWS_SECRET_ACCESS_KEY='${CONTABO_S3_SECRET_KEY}' && \
             /home/ubuntu/deploy/backup/backup-all-dbs.sh"

      - name: Cleanup
        if: always()
        run: rm -f private_key.pem
